#!/usr/bin/env bash
#
# author: daniel neemann (@zzzeyez)
#
# displays notifications on macos
# requires `ubersicht` and `imagemagick`

uber="${HOME}/Library/Application Support/Übersicht/widgets/"
image="$uber/xanthia/.cache/image.png"
message="$uber/xanthia/.cache/message"

exists() {
    type "$1" &> /dev/null ;
}

icon() {
	path="$1"
	if test -e $path -a $(file -b --mime-type $path) = "image/png"; then
		cp "$path" "$image"
	else
		convert "$path" "$image"
	fi
	ps cax | grep sicht > /dev/null
	if [ $? -eq 0 ]; then
		# stupid umlaut character
		# osascript -e 'tell application "'$(ps ax | grep sicht | awk '{print $5}' | \
		# head -1 | cut -d/ -f3 | cut -d. -f1)'" to refresh widget id "xanthia-image-coffee"'
		osascript -e 'tell application "Übersicht" to refresh widget id "xanthia-image-coffee"'
	fi
}

notify() {
	echo "$1" > "$message" &&
	ps cax | grep sicht > /dev/null
	if [ $? -eq 0 ]; then
		# stupid umlaut character
		# osascript -e 'tell application "'$(ps ax | grep sicht | awk '{print $5}' | \
		# head -1 | cut -d/ -f3 | cut -d. -f1)'" to refresh widget id "xanthia-message-coffee"'
		osascript -e 'tell application "Übersicht" to refresh widget id "xanthia-message-coffee"'
	elif exists /usr/local/bin/terminal-notifier
	then
		terminal-notifier -message "$(head -1 "$message")"
	else
		exit
	fi
}

help() {
	printf "%s" \
"xanthia: a notification system for macOS

Usage: notify-send [option] [argument]
       [-i 'path/to/image'] [-m 'message']
       
Example: notify-send -m \"file saved\"
         notify-send -i \"~/downloads/img.jpg\" -m \"img.jpg saved\"
	 notify-send -i \"~/downloads/img.jpg\"
	 notify-send \"upload finished\""
}

flags() {
	while getopts m:i: opt
		do
			case $opt in
			m) notify "$OPTARG"
			;;
			i) icon "$OPTARG"
			;;
			*) help
			;;
		esac
	done
	# if no flags are provided do message
	shift "$((OPTIND-1))" 
	if [ "$1" != "-*" ] && [ "$1" ] ;
	then
		notify "$@"
	fi
}

flags "$@"

#########
# TO DO #
#########

# support non-default uberischt directories
